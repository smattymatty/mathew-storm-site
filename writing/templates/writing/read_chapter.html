{% extends "A_base/base.html" %}
{% load static %}

{% block content %}
<div class="sb-w-full sb-mx-auto sb-py-4 sb-pr-4 md:sb-px-8 sb-max-w-6xl">
    <!-- Back to Book Cover -->
    <div class="sb-mb-6" data-storm="fade-in">
        {% if book_slug == 'labyrinth-of-sisyphus' %}
        <a href="{% url 'book_cover' %}" class="sb-btn sb-btn-ghost sb-btn-sm" data-storm-hover="lift">
            ← Back to Book Cover
        </a>
        {% elif book_slug == 'metis-wisdom-consumed' %}
        <a href="{% url 'metis_cover' %}" class="sb-btn sb-btn-ghost sb-btn-sm" data-storm-hover="lift">
            ← Back to Book Cover
        </a>
        {% endif %}
    </div>

    <!-- Top Navigation - Centered -->
    <div class="sb-grid sb-grid-cols-3 sb-items-center sb-gap-4 sb-mb-8" data-storm="fade-in">
        <!-- Left: Empty for balance -->
        <div></div>

        <!-- Center: Chapter Navigation -->
        <div class="sb-flex sb-items-center sb-gap-2 sb-justify-center">
            {% if prev_chapter %}
            <a href="{% url 'read_chapter' book_slug prev_chapter.slug %}"
               class="sb-btn sb-btn-secondary sb-btn-sm"
               data-storm-hover="lift"
               title="{{ prev_chapter.title }}">
                ←
            </a>
            {% endif %}

            <select id="chapter-selector"
                    class="chapter-select"
                    onchange="window.location.href='/writing/read/{{ book_slug }}/' + this.value + '/';">
                {% for ch in all_chapters %}
                <option value="{{ ch.slug }}" {% if ch.slug == chapter.slug %}selected{% endif %}>
                    {{ ch.title }}
                </option>
                {% endfor %}
            </select>

            {% if next_chapter %}
            <a href="{% url 'read_chapter' book_slug next_chapter.slug %}"
               class="sb-btn sb-btn-secondary sb-btn-sm"
               data-storm-hover="lift"
               title="{{ next_chapter.title }}">
                →
            </a>
            {% endif %}
        </div>

        <!-- Right: Empty for balance -->
        <div></div>
    </div>

    <!-- Chapter Title -->
    <div class="sb-text-center sb-mb-8" data-storm="fade-in" data-storm-delay="200">
        <h1 class="sb-text-4xl sb-font-bold sb-mb-2">{{ chapter.title }}</h1>
        <p class="sb-text-secondary">
            Page <span id="current-page-num">{{ current_page }}</span> of <span id="total-pages-num">{{ total_pages }}</span>
        </p>
    </div>

    <!-- Book Reader Container -->
    <div class="book-reader sb-w-full sb-max-w-5xl sb-mx-auto" data-storm="slide-up" data-storm-delay="400">
        <!-- Progress Bar -->
        <div class="sb-mb-6">
            <div class="sb-w-full sb-bg-surface sb-rounded-full sb-h-2">
                <div class="sb-bg-primary sb-h-2 sb-rounded-full sb-transition-all"
                     style="width: {{ progress_percent }}%"
                     id="progress-bar"></div>
            </div>
        </div>

        <!-- Page Content -->
        <div id="page-container"
             class="book-page{% if current_page == 1 %} first-page{% endif %}"
             data-storm="fade-in">
            <div id="page-content" class="sb-prose sb-prose-lg">
                {{ page_content|safe }}
            </div>
        </div>

        <!-- Navigation Controls -->
        <div class="sb-flex sb-justify-between sb-items-center sb-mt-8 sb-flex-wrap sb-gap-4">
            <!-- Previous Page Button -->
            <button id="prev-page-btn"
                    class="sb-btn sb-btn-primary sb-btn-lg"
                    data-storm-hover="lift"
                    data-storm-click="pulse"
                    {% if not has_prev %}disabled style="opacity: 0.3;"{% endif %}
                    data-page="{{ current_page|add:-1 }}"
                    hx-get="{% if has_prev %}{% url 'get_page' book_slug chapter.slug current_page|add:-1 %}{% endif %}"
                    hx-target="#page-content"
                    hx-swap="innerHTML"
                    hx-trigger="click">
                ← Previous
            </button>

            <!-- Page Number Display -->
            <div class="sb-flex sb-flex-col sb-items-center sb-gap-2">
                <div class="sb-text-lg sb-font-semibold">
                    Page <span id="page-display">{{ current_page }}</span> / {{ total_pages }}
                </div>
                <select id="page-jump-select"
                        class="page-jump-select sb-text-sm"
                        onchange="jumpToPage(this.value)">
                    <option value="">Jump to page...</option>
                    {% for i in "x"|rjust:total_pages %}
                        <option value="{{ forloop.counter }}" {% if forloop.counter == current_page %}selected{% endif %}>
                            Page {{ forloop.counter }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Next Page Button -->
            <button id="next-page-btn"
                    class="sb-btn sb-btn-primary sb-btn-lg"
                    data-storm-hover="lift"
                    data-storm-click="pulse"
                    {% if not has_next %}disabled style="opacity: 0.3;"{% endif %}
                    data-page="{{ current_page|add:1 }}"
                    hx-get="{% if has_next %}{% url 'get_page' book_slug chapter.slug current_page|add:1 %}{% endif %}"
                    hx-target="#page-content"
                    hx-swap="innerHTML"
                    hx-trigger="click">
                Next →
            </button>
        </div>
    </div>
</div>

<script>
    const TOTAL_PAGES = {{ total_pages }};
    const BOOK_SLUG = "{{ book_slug }}";
    const CHAPTER_SLUG = "{{ chapter.slug }}";
    let currentPage = {{ current_page }};

    // Jump to specific page from dropdown
    function jumpToPage(pageNum) {
        if (!pageNum) return; // Ignore "Jump to page..." option

        const targetPage = parseInt(pageNum);
        if (targetPage < 1 || targetPage > TOTAL_PAGES || targetPage === currentPage) {
            return;
        }

        console.log('Jumping to page:', targetPage);

        // Fetch the page content
        fetch(`/writing/api/get-page/${BOOK_SLUG}/${CHAPTER_SLUG}/${targetPage}/`)
            .then(response => {
                const newPage = parseInt(response.headers.get('X-Current-Page'));
                return response.text().then(html => ({ html, newPage }));
            })
            .then(({ html, newPage }) => {
                document.getElementById('page-content').innerHTML = html;
                updatePageNumber(newPage);

                // Scroll to top (to book-reader to show progress bar)
                const bookReader = document.querySelector('.book-reader');
                if (bookReader) {
                    bookReader.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            })
            .catch(error => console.error('Error jumping to page:', error));
    }

    // Update page numbers and URLs
    function updatePageNumber(newPage) {
        console.log('updatePageNumber called:', newPage, '/', TOTAL_PAGES);

        // Ensure page number is valid (between 1 and totalPages)
        newPage = Math.max(1, Math.min(newPage, TOTAL_PAGES));
        currentPage = newPage;

        document.getElementById('current-page-num').textContent = newPage;
        document.getElementById('page-display').textContent = newPage;

        // Update progress bar
        const progressPercent = (newPage / TOTAL_PAGES) * 100;
        document.getElementById('progress-bar').style.width = progressPercent + '%';

        // Update first-page class for drop cap
        const pageContainer = document.getElementById('page-container');
        if (pageContainer) {
            if (newPage === 1) {
                pageContainer.classList.add('first-page');
            } else {
                pageContainer.classList.remove('first-page');
            }
        }

        // Update button states and URLs
        const prevBtn = document.getElementById('prev-page-btn');
        const nextBtn = document.getElementById('next-page-btn');

        if (newPage <= 1) {
            prevBtn.disabled = true;
            prevBtn.style.opacity = '0.3';
            prevBtn.removeAttribute('hx-get');
        } else {
            prevBtn.disabled = false;
            prevBtn.style.opacity = '1';
            prevBtn.setAttribute('hx-get', `/writing/api/get-page/${BOOK_SLUG}/${CHAPTER_SLUG}/${newPage - 1}/`);
            prevBtn.setAttribute('data-page', newPage - 1);
        }

        if (newPage >= TOTAL_PAGES) {
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.3';
            nextBtn.removeAttribute('hx-get');
        } else {
            nextBtn.disabled = false;
            nextBtn.style.opacity = '1';
            nextBtn.setAttribute('hx-get', `/writing/api/get-page/${BOOK_SLUG}/${CHAPTER_SLUG}/${newPage + 1}/`);
            nextBtn.setAttribute('data-page', newPage + 1);
        }

        // Re-process HTMX attributes
        if (window.htmx) {
            htmx.process(prevBtn);
            htmx.process(nextBtn);
        }

        // Update page jump dropdown
        const pageJumpSelect = document.getElementById('page-jump-select');
        if (pageJumpSelect) {
            pageJumpSelect.value = newPage;
        }

        // Update URL without reload
        const url = new URL(window.location);
        url.searchParams.set('page', newPage);
        window.history.pushState({}, '', url);
    }

    // Listen for HTMX after swap to update page state
    document.body.addEventListener('htmx:afterSwap', function(event) {
        console.log('HTMX swap completed');
        const target = event.detail.target;

        if (target.id === 'page-content') {
            // Read page number from response headers
            const xhr = event.detail.xhr;
            const newPage = parseInt(xhr.getResponseHeader('X-Current-Page'));
            const totalPages = parseInt(xhr.getResponseHeader('X-Total-Pages'));

            console.log('New page from headers:', newPage, '/', totalPages);

            if (newPage && !isNaN(newPage)) {
                updatePageNumber(newPage);
            }

            // Scroll to top (to book-reader to show progress bar)
            const bookReader = document.querySelector('.book-reader');
            if (bookReader) {
                bookReader.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    });

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft' && !document.getElementById('prev-page-btn').disabled) {
            document.getElementById('prev-page-btn').click();
        } else if (e.key === 'ArrowRight' && !document.getElementById('next-page-btn').disabled) {
            document.getElementById('next-page-btn').click();
        }
    });

    console.log('Page reader initialized. Current page:', currentPage, '/', TOTAL_PAGES);
</script>

<style>
    .book-reader {
        font-family: 'Georgia', serif;
    }

    /* Book page styling - clean background like a real book */
    .book-page {
        background-color: var(--sb-background, #090a14);
        padding: 3rem;
        min-height: 24rem;
        border-radius: 0.5rem;
    }

    @media (max-width: 768px) {
        .book-page {
            padding: 1.5rem;
        }
    }

    #page-content {
        line-height: 1.8;
        font-size: 1.1rem;
        max-width: 100%;
    }

    #page-content p {
        margin-bottom: 1.5rem;
        text-indent: 2rem;
    }

    #page-content p:first-of-type {
        text-indent: 0;
    }

    /* Drop cap - only on first page */
    .first-page #page-content p:first-of-type::first-letter {
        font-size: 3.5rem;
        font-weight: bold;
        float: left;
        line-height: 1;
        margin-right: 0.5rem;
        margin-top: 0.1rem;
        color: var(--sb-primary, #4f8fba);
    }

    #page-content h1,
    #page-content h2 {
        text-indent: 0;
        margin-top: 2rem;
        margin-bottom: 1rem;
    }

    /* Dark theme dropdown styling */
    .chapter-select,
    .page-jump-select {
        background-color: var(--sb-surface, #151d28);
        color: var(--sb-text, #d7b594);
        border: 1px solid var(--sb-neutral, #394a50);
        padding: 0.5rem 2rem 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23d7b594'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        background-size: 1.25rem;
        max-width: 300px;
    }

    .page-jump-select {
        font-size: 0.75rem;
        padding: 0.25rem 1.5rem 0.25rem 0.5rem;
        max-width: 150px;
    }

    .chapter-select:hover,
    .page-jump-select:hover {
        border-color: var(--sb-primary, #4f8fba);
        background-color: var(--sb-subtle, #202e37);
    }

    .chapter-select:focus,
    .page-jump-select:focus {
        outline: none;
        border-color: var(--sb-primary, #4f8fba);
        box-shadow: 0 0 0 3px rgba(79, 143, 186, 0.1);
    }

    .chapter-select option,
    .page-jump-select option {
        background-color: var(--sb-surface, #151d28);
        color: var(--sb-text, #d7b594);
        padding: 0.5rem;
    }

    /* Smooth fade transition for HTMX swaps */
    .htmx-swapping {
        opacity: 0;
        transition: opacity 300ms ease-out;
    }

    .htmx-settling {
        opacity: 1;
        transition: opacity 300ms ease-in;
    }
</style>
{% endblock %}
